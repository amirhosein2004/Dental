{% extends 'base.html' %}
{% load static %}

{% block title %} پیام ها {% endblock %}

{% block extra_static %}
    <link rel="stylesheet" href="{% static 'contact/css/contact_massages.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <header class="mb-5 text-center">
        <h2 class="display-5 fw-bold text-primary">مدیریت پیام‌ها</h2>
    </header>

    <!-- Controls -->
    <nav class="mb-5 d-flex flex-wrap justify-content-between align-items-center gap-3 bg-light p-3 rounded-3 shadow">
        <div class="btn-group btn-group-lg" role="group" aria-label="فیلتر پیام‌ها">
            <a href="?filter=all" class="btn btn-outline-dark {% if filter_status == 'all' %}active{% endif %}" 
               aria-pressed="{% if filter_status == 'all' %}true{% else %}false{% endif %}">
                <i class="fas fa-list me-2"></i>همه پیام‌ها
            </a>
            <a href="?filter=read" class="btn btn-outline-success {% if filter_status == 'read' %}active{% endif %}" 
               aria-pressed="{% if filter_status == 'read' %}true{% else %}false{% endif %}">
                <i class="fas fa-check-circle me-2"></i>خوانده‌شده
            </a>
            <a href="?filter=unread" class="btn btn-outline-danger {% if filter_status == 'unread' %}active{% endif %}" 
               aria-pressed="{% if filter_status == 'unread' %}true{% else %}false{% endif %}">
                <i class="fas fa-exclamation-circle me-2"></i>خوانده‌نشده
            </a>
        </div>
        
        <form id="markAllForm" action="{% url 'contact:mark_all_read' %}" method="post" class="d-inline-block">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning btn-lg fw-medium shadow-sm">
                <i class="fas fa-check-double me-2"></i>علامت‌گذاری همه
            </button>
        </form>
    </nav>

    <!-- Messages Table -->
    <div class="table-responsive rounded-3 shadow border">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-dark bg-gradient">
                <tr>
                    <th scope="col" class="py-3 px-4 text-nowrap">نام</th>
                    <th scope="col" class="py-3 px-4 text-nowrap">شماره تماس</th>
                    <th scope="col" class="py-3 px-4">پیام</th>
                    <th scope="col" class="py-3 px-4 text-nowrap">تاریخ</th>
                    <th scope="col" class="py-3 px-4 text-nowrap">وضعیت</th>
                    <th scope="col" class="py-3 px-4 text-center text-nowrap">عملیات</th>
                </tr>
            </thead>
            <tbody>
                {% for message in messages_list %}
                <tr>
                    <td class="px-4 text-nowrap">{{ message.name|truncatechars:25 }}</td>
                    <td class="px-4 text-nowrap" dir="ltr">
                        <a href="tel:{{ message.phone }}" class="text-decoration-none text-primary" title="تماس">
                            {{ message.phone }}
                        </a>
                    </td>
                    <td class="px-4" style="min-width: 400px;">
                        <span class="message-text text-break">
                            {{ message.message|truncatechars:100 }}
                        </span>
                    </td>
                    <td class="px-4 text-nowrap">{{ message.get_created_at_jalali }}</td>
                    <td class="px-4">
                        <span class="badge w-100 rounded-pill {% if message.is_read %}bg-success{% else %}bg-danger{% endif %}">
                            <i class="fas fa-{% if message.is_read %}check{% else %}exclamation{% endif %} me-2"></i>
                            {% if message.is_read %}خوانده‌شده{% else %}خوانده‌نشده{% endif %}
                        </span>
                    </td>
                    <td class="px-4 text-center">
                        <div class="d-flex justify-content-center gap-2">
                            {% if not message.is_read %}
                                <form action="{% url 'contact:mark_as_read' message.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-primary shadow-sm" 
                                            title="علامت‌گذاری به عنوان خوانده‌شده">
                                        <i class="fas fa-check me-2"></i>خوانده شود
                                    </button>
                                </form>
                            {% endif %}
                            <button class="btn btn-sm btn-info shadow-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#messageModal{{ message.id }}"
                                    title="مشاهده کامل پیام">
                                <i class="fas fa-eye me-2"></i>مشاهده
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-75"></i>
                        <p class="mb-0 fs-4 fw-medium">هیچ پیامی یافت نشد</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Full Text Modals -->
    {% for message in messages_list %}
    <div class="modal fade" id="messageModal{{ message.id }}" tabindex="-1" 
         aria-labelledby="messageModalLabel{{ message.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold" id="messageModalLabel{{ message.id }}">مشاهده کامل پیام</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
                <div class="modal-body py-4">
                    <p><strong>نام:</strong> {{ message.name }}</p>
                    <p><strong>شماره تماس:</strong> 
                        <a href="tel:{{ message.phone }}" class="text-decoration-none text-primary">
                            {{ message.phone }}
                        </a>
                    </p>
                    <p><strong>تاریخ:</strong> {{ message.get_created_at_jalali }}</p>
                    <hr>
                    <p class="lead text-break lh-lg">{{ message.message|linebreaks }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info" data-bs-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Mark All Success Modal -->
    <div class="modal fade" id="markAllModal" tabindex="-1" aria-labelledby="markAllModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold" id="markAllModalLabel">عملیات موفق</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
                <div class="modal-body">
                    همه پیام‌ها با موفقیت به عنوان خوانده‌شده علامت‌گذاری شدند.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark All Confirmation Modal -->
    <div class="modal fade" id="confirmMarkAllModal" tabindex="-1" aria-labelledby="confirmMarkAllModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="confirmMarkAllModalLabel">تأیید عملیات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
                <div class="modal-body">
                    آیا از علامت‌گذاری همه پیام‌ها به عنوان خوانده‌شده مطمئن هستید؟
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="button" class="btn btn-warning" id="confirmMarkAllBtn">تأیید</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'contact/js/contact_messages.js' %}"></script>
{% endblock %}