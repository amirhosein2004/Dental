{% extends 'base.html' %}

{% block content %}
<style>
  :root {
    --primary-color: #2A2F4F;
    --secondary-color: #917FB3;
    --accent-color: #E5BEEC;
    --bg-light: #f8f9fa;
    --text-dark: #2D3250;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Dashboard Container */
  .dashboard-container {
    display: flex;
    min-height: 80vh;
    gap: 2rem;
    background: var(--bg-light);
    border-radius: 1rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    width: 280px;
    background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
    padding: 2rem 1.5rem;
    color: white;
    border-radius: 1rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }

  .sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar li {
    margin-bottom: 1rem;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    border-radius: 0.5rem;
    transition: var(--transition);
  }

  .sidebar a:hover,
  .sidebar a.active {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
  }

  /* Main Content */
  .content {
    flex: 1;
    padding: 2rem;
    background: white;
    border-radius: 1rem;
  }

  .content-section {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .content-section.active {
    display: block;
  }

  /* Sub-menu */
  .sub-menu {
    margin: 2rem 0;
    border-bottom: 2px solid var(--bg-light);
  }

  .sub-menu ul {
    display: flex;
    gap: 1rem;
    padding: 0;
  }

  .sub-menu a {
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    background: var(--bg-light);
    color: var(--text-dark);
    text-decoration: none;
    transition: var(--transition);
    position: relative;
  }

  .sub-menu a.active,
  .sub-menu a:hover {
    background: var(--primary-color);
    color: white;
  }

  .sub-menu a.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--accent-color);
  }

  .sub-content-section {
    display: none;
    padding: 1.5rem;
    background: var(--bg-light);
    border-radius: 0.75rem;
    margin-top: 1rem;
  }

  .sub-content-section.active {
    display: block;
    animation: slideUp 0.3s ease;
  }

  /* Profile Info */
  .profile-info p,
  .social-links p {
    padding: 0.75rem;
    background: white;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  /* Blog Post */
  .blog-post {
    padding: 1.5rem;
    background: var(--bg-light);
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    transition: var(--transition);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .blog-post:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Gallery Grid */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .gallery-img {
    border-radius: 0.75rem;
    overflow: hidden;
    transition: var(--transition);
    position: relative;
  }

  .gallery-img img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .gallery-img:hover img {
    transform: scale(1.05);
  }

  /* Save Button */
  #global-save-btn {
    padding: 0.75rem 2rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    transition: transform 0.3s ease;
    cursor: pointer;
  }

  #global-save-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  /* Profile Image Hover Effect */
  .profile-image-container:hover {
    border: 2px solid var(--primary-color);
    cursor: pointer;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .dashboard-container {
      flex-direction: column;
    }
    .sidebar {
      width: 100%;
      padding: 1.5rem;
    }
    .content {
      padding: 1.5rem;
    }
  }
</style>

<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li><a href="#" class="menu-link active" data-target="profile-section">📁 پروفایل پزشک</a></li>
      <li><a href="#" class="menu-link" data-target="blog-section">📚 بلاگ‌های من</a></li>
      <li><a href="#" class="menu-link" data-target="gallery-section">🖼️ گالری من</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Profile Section -->
    <div id="profile-section" class="content-section active">
      <h2 class="section-title">👨⚕️ پروفایل پزشک</h2>
      
      <!-- Sub-menu for Profile -->
      <div class="sub-menu">
        <ul>
          <li><a href="#" class="sub-menu-link active" data-target="account-info">🔐 اطلاعات کاربری</a></li>
          <li><a href="#" class="sub-menu-link" data-target="self-intro">📝 معرفی خود</a></li>
          <li><a href="#" class="sub-menu-link" data-target="social-media">🌐 شبکه‌های اجتماعی</a></li>
        </ul>
      </div>

      <!-- Profile Update Form -->
      <form id="profile-form" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Account Information Sub-section -->
        <div id="account-info" class="sub-content-section active">
          <div class="profile-info">
            <div class="profile-image-container">
              {% if doctor.user.image %}
                <img id="profile-preview" src="{{ doctor.user.image.url }}" alt="عکس پروفایل" class="profile-image" style="max-width: 150px; border-radius: 50%;">
              {% else %}
                <img id="profile-preview" src="/media/users/default.png" alt="عکس پیش‌فرض" class="profile-image" style="max-width: 150px; border-radius: 50%;">
              {% endif %}
              <label for="id_image">انتخاب عکس جدید:</label>
              {{ user_form.image }}
            </div>
            <p><strong>👤 نام کاربری:</strong> {{ user_form.username }}</p>
            <p><strong>📧 ایمیل:</strong> {{ user_form.email }}</p>
            <p><strong>👨⚕️ نام:</strong> {{ user_form.first_name }}</p>
            <p><strong>🏷️ نام خانوادگی:</strong> {{ user_form.last_name }}</p>
          </div>
        </div>

        <!-- Self Introduction Sub-section -->
        <div id="self-intro" class="sub-content-section">
          <div class="intro-box">
            <h3>📌 معرفی تخصصی</h3>
            {{ doctor_form.description }}
          </div>
        </div>

        <!-- Social Links Sub-section -->
        <div id="social-media" class="sub-content-section">
          <div class="social-links">
            <p><strong>Twitter:</strong> {{ doctor_form.twitter }}</p>
            <p><strong>Instagram:</strong> {{ doctor_form.instagram }}</p>
            <p><strong>Telegram:</strong> {{ doctor_form.telegram }}</p>
            <p><strong>LinkedIn:</strong> {{ doctor_form.linkedin }}</p>
          </div>
        </div>

        <!-- Save Button -->
        <div style="margin-top: 1.5rem;">
          <button type="button" id="global-save-btn">💾 ذخیره تغییرات</button>
        </div>
      </form>
    </div>

    <!-- Blog Section -->
    <div id="blog-section" class="content-section">
      <h2 class="section-title">📰 آخرین مقالات</h2>
      <a href="{% url 'blog:create_blog' %}" class="btn btn-primary">➕ افزودن مقاله جدید</a>
      {% if blogs %}
        {% for blog in blogs %}
          <div class="blog-post">
            <h4 class="blog-title">{{ blog.title }}</h4>
            <p class="blog-excerpt">{{ blog.content|truncatewords:30 }}</p>
            <a href="{% url 'blog:blog_detail' blog.id %}" class="read-more">📖 ادامه مطلب →</a>
            <div class="management-buttons">
              <a href="{% url 'blog:update_blog' blog.id %}" class="btn btn-warning">✏️ ویرایش</a>
              <a href="{% url 'blog:delete_blog' blog.id %}" class="btn btn-danger" onclick="return confirm('آیا مطمئن هستید؟')">🗑 حذف</a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <p>📭 هنوز مقاله‌ای منتشر نکرده‌اید!</p>
        </div>
      {% endif %}
    </div>

    <!-- Gallery Section -->
    <div id="gallery-section" class="content-section">
      <h2 class="section-title">🖼️ گالری تصاویر</h2>
      <a href="{% url 'gallery:add_gallery' %}" class="btn btn-primary">➕ افزودن تصویر جدید</a>
      {% if galleries %}
        <div class="gallery-grid">
          {% for gallery in galleries %}
            <div class="gallery-category">
              <h4 class="gallery-title">{{ gallery.category }}</h4>
              <div class="gallery-management">
                <a href="{% url 'gallery:update_gallery' gallery.id %}" class="btn btn-warning">✏️ ویرایش</a>
                <a href="{% url 'gallery:delete_gallery' gallery.id %}" class="btn btn-danger" onclick="return confirm('آیا مطمئن هستید؟')">🗑 حذف</a>
              </div>
              <div class="gallery-images">
                {% for image in gallery.images.all %}
                  <div class="gallery-img">
                    <img src="{{ image.image.url }}" alt="Gallery Image">
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <p>📷 گالری شما خالی است!</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Activate menu sections
    const activateSection = (target) => {
      document.querySelectorAll('.menu-link').forEach(link => link.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      
      const activeLink = document.querySelector(`.menu-link[data-target="${target}"]`);
      if (activeLink) activeLink.classList.add('active');
      
      const activeSection = document.getElementById(target);
      if (activeSection) activeSection.classList.add('active');
    };

    document.querySelectorAll('.menu-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        activateSection(this.dataset.target);
      });
    });

    // Save form data via AJAX
    document.getElementById('global-save-btn').addEventListener('click', function() {
      const form = document.getElementById('profile-form');
      const formData = new FormData(form);

      // Optionally add profile picture if available
      const profilePicInput = document.querySelector('#id_profile_picture');
      if (profilePicInput && profilePicInput.files.length > 0) {
        formData.append('profile_picture', profilePicInput.files[0]);
      }

      fetch("{% url 'dashboard:edit_profile' doctor.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": formData.get('csrfmiddlewaretoken')
        },
        body: formData
      })
      .then(response => response.json())
      .then(result => {
        if (result.status === "success") {
          alert(result.message);
          location.reload();
        } else {
          alert("خطا: " + result.message);
          console.log(result.errors);
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("خطایی رخ داده است.");
      });
    });

    // Handle sub-menu links
    const subMenuLinks = document.querySelectorAll('.sub-menu-link');
    if (subMenuLinks.length) {
      subMenuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelectorAll('.sub-menu-link').forEach(l => l.classList.remove('active'));
          document.querySelectorAll('.sub-content-section').forEach(section => section.classList.remove('active'));
          
          this.classList.add('active');
          const subTarget = this.dataset.target;
          const activeSubSection = document.getElementById(subTarget);
          if (activeSubSection) activeSubSection.classList.add('active');
        });
      });
    }
  });
</script>
{% endblock %}
